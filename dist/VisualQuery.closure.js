$.fn.focus=function(c,b){if(this[0]){if(1<=arguments.length&&Array.prototype.every.call(arguments,function(b){return Math.floor(b)===b&&$.isNumeric(b)})){if(this[0].setSelectionRange)return this[0].setSelectionRange(c,b||c);if(this[0].createTextRange){var d=this[0].createTextRange();d.collapse(!0);d.moveEnd("character",b||c);d.moveStart("character",c);d.select()}}else if(2===arguments.length)return this.on("focus",null,c,b);return this.trigger("focus")}};
$.fn.visualquery=function(c){c=$.extend({strict:!1,parameters:[],defaultQuery:[],callback:$.noop()},c);var b=$("<div>",{"class":"parameters"}),d={},g={names:[]};c.parameters.forEach(function(a){d[a.name]=a;console.log(a);g.names.push(a.name);a.operators&&(console.log("Operators"),g[a.name+"_operators"]={},Array.prototype.map.bind(a.operators,function(a){console.log(a)}));a.values&&(console.log("Values"),$("<datalist></datalist>",{id:a.name+"_values"}).append(Array.prototype.map.bind(a.values,function(a){return $("<option></option>",
{text:a})})).appendTo(b))});var l=function(){var a=a("<ul></ul>");return{lis:function(a){},input:function(){},hide:function(){},show:function(){}}}(),h=function(a,k,m){var e=this;this.$=$("<div>",{"class":"parameter"}).append($("<span></span>",{id:"remove",html:"&times;"}).on("click",function(){e.$.remove()}),this.name=$("<input>",{type:"text",spellcheck:"false",autocomplete:"off",id:"name",value:a,style:"width:1px;",list:"names"}),this.operator=$("<input>",{type:"text",spellcheck:"false",autocomplete:"off",
id:"operator",value:k,style:"width:1px;"}),this.value=$("<input>",{type:"text",spellcheck:"false",autocomplete:"off",id:"value",value:m,style:"width:10px;"})).on("keydown","input",function(a){var b=$(a.target);13===a.keyCode&&b.next().focus()}).on("blur","input",function(a){}).on("input","input",function(a){a=$(this);var f=a.val(),e=0!==f.length?f:a.attr("placeholder")||"";console.log(f,f.length,a.attr("type"));f=$("<span>",{"class":c["class"]}).css(jQuery.extend({position:"absolute",width:"auto",
visibility:"hidden",whiteSpace:"pre"},a.css("font-size font-family font-weight font-style font-variant word-spacing letter-spacing text-indent text-rendering text-transform".split(" ")))).text(e).appendTo(b);e=f.width();f.remove();a.width(e+({number:17,date:57}[a.attr("type")]||0)+1+(void 0!==a.attr("list")?20:0));l.input()});this.name.on("focus",function(){console.log("Open autoComplete")}).on("blur",function(){var a=e.name.val(),b=d[a]||{};e.operator.attr(jQuery.extend({placeholder:""},b.operatorAttrs||
{},{type:"text",list:a})).trigger("input");e.value.attr(jQuery.extend({type:"text",placeholder:""},b.valueAttrs||{},{type:b.type||b.valueAttrs&&b.valueAttrs.type||"text",list:a+"_values"})).trigger("input");if(c.strict&&!d.hasOwnProperty(a))return"Error"});this.value.on("blur",function(){e.value[0].checkValidity()?e.$.removeClass("error"):e.$.addClass("error")})};c.defaultQuery.forEach(function(a){if(!c.strict||a.name in d)a=new h(a.name,a.operator,a.value,a.type),a.$.appendTo(b)});b.on("focusin",
function(){b.addClass("selected")}).on("blur","input",function(){b.removeClass("selected")}).on("mousedown",function(a){if($(a.target).is(b)){a.preventDefault();$("div.parameter.selected",b).removeClass("selected");var c;$("div.parameter",b).each(function(){var b=$(this),d=b.offset();if(d.top>a.pageY||d.top<a.pageY&&a.pageY<d.top+b.height()&&d.left>a.pageX)return!1;c=b});var d=new h;d.$[void 0!==c?"insertAfter":"prependTo"](c||this);d.name.focus()}});this.html(b)};
