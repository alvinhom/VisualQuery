$.fn.focus=function(b,k){if(this[0]){if(1<=arguments.length&&Array.prototype.every.call(arguments,function(b){return Math.floor(b)===b}))if(this[0].setSelectionRange)try{return this[0].setSelectionRange(b,k||b)}catch(m){}else{if(this[0].createTextRange){var d=this[0].createTextRange();d.collapse(!0);d.moveEnd("character",k||b);d.moveStart("character",b);d.select()}}else if(2===arguments.length)return this.on("focus",null,b,k);return this.trigger("focus")}};
$.fn.visualquery=function(b){b=$.extend({strict:!1,parameters:[],defaultQuery:[],placeholder:"",callback:$.noop()},b);var k=function(){b.callback(h.list.map(function(a){return a.validate()&&{name:a.name.val(),operator:e[a.name.val()+"_operators"]&&e[a.name.val()+"_operators"][a.operator.val()]||a.operator.val(),value:e[a.name.val()+"_values"]&&e[a.name.val()+"_values"][a.value.val()]||a.value.val()}}).filter(function(a){return a}))},m=$("<div></div>",{"class":"placeholder",style:"pointer-events: none;",
text:b.placeholder}),d=$("<div>",{"class":"parameters",html:m}).on({focusin:function(){d.addClass("selected")},focusout:function(){d.removeClass("selected")},mousedown:function(a){if($(a.target).is(d)){a.preventDefault();$("div.parameter.selected",d).removeClass("selected");var b;$("div.parameter",d).each(function(){var c=$(this),f=c.offset();if(f.top>a.pageY||f.top<a.pageY&&a.pageY<f.top+c.height()&&f.left>a.pageX)return!1;b=c});var e=new n;e.$[void 0!==b?"insertAfter":"prependTo"](b||this);e.name.focus();
h.update()}}}),h={list:[],update:function(){var a=this,b=d.children("div.parameter");this.list=[];m[b.length?"hide":"show"]();b.each(function(){a.list.push($(this).data("Parameter"))});return this}},p={},e={names:[]};b.parameters.forEach(function(a){p[a.name]=a;e.names.push(a.name);e[a.name+"_operators"]=a.operators&&a.operators;e[a.name+"_values"]=a.values&&a.values});var l=function(a){var b,d,c,f=$("<ul>",{"class":"autoComplete"}).css({position:"absolute",display:"none"}).on("mouseover","li",function(){$(this).addClass("selected").siblings(".selected").removeClass("selected")}).on("mousedown",
"li",function(a){a.preventDefault();b.val($(a.target).attr("value")).trigger("input").trigger("blur").next("input").focus()}),g=function(){var g=!1,e=d.map(function(f){if(f.match(new RegExp(b.val(),"i")))return $("<li>",{text:f,"class":!0===a.strict&&!1===g&&(g=!0)?"selected":""}).attr("value",f)}).filter(function(a){return a});c=c||parseInt(f.find("li").css("padding-left"));return e.length?f.html(e).show():f.hide()};return{$:f,targetInput:function(a){return(b=$(a).on({input:g.bind(this),blur:function(){$(this).unbind("keydown input")},
keydown:function(a){var b=$(this),c;13===a.keyCode&&(a.preventDefault(),f.is(":visible")&&1===(c=f.children(".selected")).length&&b.val(c.text()).trigger("input"),b.blur().next().focus());if(f.is(":visible")&&(40===a.keyCode||38===a.keyCode))return a.preventDefault(),a=40===a.keyCode?"next":"prev",(c=f.children(".selected"))[a]().length&&c.removeClass("selected")[a]().addClass("selected")}}))&&this},setLis:function(a){return(d=$.isArray(a)?a:Object.keys(a))&&g()&&this},show:function(a){0!==d.length&&
f.show().offset({top:a.top+b.height(),left:a.left-(c||0)})}}}(b),q=function(a){try{return 0===a.selectionStart&&0===a.selectionEnd}catch(b){return!1}},r=function(a,b){try{return a.val().length===b.selectionStart&&a.val().length===b.selectionEnd}catch(d){return!1}},n=function(a,m,n){var c=this;this.remove=function(){c.$.remove();h.update();k()};this.validate=function(){var a=c.name.val(),g=c.operator.val(),d=c.value.val();return(a+g+d).length?a.length&&g.length&&d.length?b.strict&&!p.hasOwnProperty(a)?
c.$.addClass("error").attr("title","Invalid Parameter")&&!1:c.value[0].checkValidity()?!0:c.$.addClass("error").attr("title",c.value[0].validationMessage)&&!1:(c.$.addClass("error"),!1):c.remove()&&!1};this.$=$("<div>",{"class":"parameter"}).data("Parameter",this).append($("<span></span>",{id:"remove",html:"&times;"}).on("click",c.remove),this.name=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"name",value:a,style:"width:1px;"}).on({focus:function(){l.setLis(e.names).show($(this).offset())},
blur:function(){var a=c.name.val(),a=p[a]||{};c.operator.attr(jQuery.extend({placeholder:""},a.operatorAttrs||{},{type:"text"})).trigger("input");c.value.attr(jQuery.extend({placeholder:""},a.valueAttrs||{},{type:-1!==["text","email","number","url"].indexOf(a.type)&&a.type||"text"})).trigger("input")}}),this.operator=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"operator",value:m,style:"width:1px;"}).on("focus",function(){l.setLis(e[c.name.val()+"_operators"]||[]).show($(this).offset())}),
this.value=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"value",value:n,style:"width:10px;"}).on("focus",function(){l.setLis(e[c.name.val()+"_values"]||[]).show($(this).offset())})).on("keydown","input#name",function(a){q(this)&&37===a.keyCode&&(a.preventDefault(),(a=h.list[h.list.indexOf(c)-1])&&a.value.focus())}).on("keydown","input#value",function(a){r($(this),this)&&39===a.keyCode&&(a.preventDefault(),(a=h.list[h.list.indexOf(c)+1])&&a.name.focus(0))}).on({keydown:function(a){var b=
$(this);r(b,this)&&39===a.keyCode&&(a.preventDefault(),b.next().focus(0));!q(this)||37!==a.keyCode&&8!==a.keyCode||(a.preventDefault(),b.prev().focus())},blur:function(){c.$.removeClass("selected");c.validate();l.$.hide();k()},focus:function(){c.$.removeClass("error").addClass("selected");l.targetInput(this)},input:function(){var a=$(this),c=a.val(),c=0!==c.length?c:a.attr("placeholder")||"",c=$("<span>",{"class":b["class"]}).css(jQuery.extend({position:"absolute",width:"auto",visibility:"hidden",
whiteSpace:"pre"},a.css("font-size font-family font-weight font-style font-variant word-spacing letter-spacing text-indent text-rendering text-transform".split(" ")))).text(c).appendTo(d),e=c.width();c.remove();console.log("Width",e);a.width((e||10)+1+({number:17}[a.attr("type")]||0))}},"input")};b.defaultQuery.forEach(function(a){if(!b.strict||a.name in p)a=new n(a.name,a.operator,a.value,a.type),a.$.appendTo(d)});this.html([d,l.$])};
