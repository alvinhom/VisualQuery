/*! VisualQuery 2014-04-13 */
!function(a){a.fn.focus=function(b,c){"use strict";if(this[0]){if(arguments.length>=1&&Array.prototype.every.call(arguments,function(b){return Math.floor(b)===b&&a.isNumeric(b)})){if(this[0].setSelectionRange)return this[0].setSelectionRange(b,c||b);if(this[0].createTextRange){var d=this[0].createTextRange();d.collapse(!0),d.moveEnd("character",c||b),d.moveStart("character",b),d.select()}}else if(2===arguments.length)return this.on("focus",null,b,c);return this.trigger("focus")}},a.fn.visualquery=function(b){"use strict";b=a.extend({strict:!1,parameters:[],defaultQuery:[],callback:a.noop()},b);var c=a("<div>",{"class":"parameters"}),d={},e={names:[]};b.parameters.forEach(function(a){d[a.name]=a,e.names.push(a.name),e[a.name+"_operators"]=a.operators&&a.operators,e[a.name+"_values"]=a.values&&a.values});var f=function(b){var c,d,e,f=a("<ul>",{"class":"autoComplete"}).css({position:"absolute",display:"none"}).on("mouseover","li",function(){a(this).siblings(".selected").removeClass("selected"),a(this).addClass("selected")}).on("mousedown","li",function(b){b.preventDefault(),c.val(a(b.target).attr("value")).blur().next("input").focus()}),g=function(){var g=!1;return f.html(d.map(function(d){return d.match(c.val())?a("<li>",{text:d,"class":b.strict===!0&&g===!1&&(g=!0)?"selected":""}).attr("value",d):!1})),e=e||parseInt(f.find("li").css("padding-left")),1};return{$:f,targetInput:function(b){return(c=a(b))&&this},setLis:function(a){return(d=a)&&g()&&this},show:function(a){f.show().offset({top:a.top+c.height(),left:a.left-(e||0)})}}}(b),g=function(g,h,i){var j=this;this.$=a("<div>",{"class":"parameter"}).append(a("<span></span>",{id:"remove",html:"&times;"}).on("click",function(){j.$.remove()}),this.name=a("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"name",value:g,style:"width:1px;",list:"names"}),this.operator=a("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"operator",value:h,style:"width:1px;"}),this.value=a("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"value",value:i,style:"width:10px;"})).on({keydown:function(b){var c=a(b.target);13===b.keyCode&&c.next().focus()},blur:function(){f.$.hide()},input:function(){var d={number:17,date:57},e=a(this),f=e.val(),g=0!==f.length?f:e.attr("placeholder")||"";console.log(f,f.length,e.attr("type"));var h=a("<span>",{"class":b["class"]}).css(jQuery.extend({position:"absolute",width:"auto",visibility:"hidden",whiteSpace:"pre"},e.css(["font-size","font-family","font-weight","font-style","font-variant","word-spacing","letter-spacing","text-indent","text-rendering","text-transform"]))).text(g).appendTo(c),i=h.width();h.remove(),e.width(i+(d[e.attr("type")]||0)+1+(void 0!==e.attr("list")?20:0))}},"input"),this.name.on("focus",function(b){f.targetInput(b.target).setLis(e.names).show(a(this).offset())}).on("blur",function(){var a=j.name.val(),c=d[a]||{};return j.operator.attr(jQuery.extend({placeholder:""},c.operatorAttrs||{},{type:"text",list:a})).trigger("input"),j.value.attr(jQuery.extend({type:"text",placeholder:""},c.valueAttrs||{},{type:c.type||c.valueAttrs&&c.valueAttrs.type||"text",list:a+"_values"})).trigger("input"),b.strict&&!d.hasOwnProperty(a)?"Error":void 0}),this.value.on("blur",function(){j.value[0].checkValidity()?j.$.removeClass("error"):j.$.addClass("error")})};b.defaultQuery.forEach(function(a){(!b.strict||a.name in d)&&(a=new g(a.name,a.operator,a.value,a.type),a.$.appendTo(c))}),c.on("focusin",function(){c.addClass("selected")}).on("blur","input",function(){c.removeClass("selected")}).on("mousedown",function(b){if(a(b.target).is(c)){b.preventDefault(),a("div.parameter.selected",c).removeClass("selected");var d;a("div.parameter",c).each(function(){var c=a(this),e=c.offset();return e.top>b.pageY||e.top<b.pageY&&b.pageY<e.top+c.height()&&e.left>b.pageX?!1:void(d=c)});var e=new g;e.$[void 0!==d?"insertAfter":"prependTo"](d||this),e.name.focus()}}),this.html([c,f.$])}}(window.jQuery);