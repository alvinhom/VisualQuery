/*! VisualQuery 2014-04-12 */
!function(a){a.fn.focus=function(b,c){"use strict";if(this[0]){if(arguments.length>=1&&Array.prototype.every.call(arguments,function(b){return Math.floor(b)===b&&a.isNumeric(b)})){if(this[0].setSelectionRange)return this[0].setSelectionRange(b,c||b);if(this[0].createTextRange){var d=this[0].createTextRange();d.collapse(!0),d.moveEnd("character",c||b),d.moveStart("character",b),d.select()}}else if(2===arguments.length)return this.on("focus",null,b,c);return this.trigger("focus")}},a.fn.visualquery=function(b){"use strict";b=a.extend({strict:!1,parameters:[],defaultQuery:[],callback:a.noop()},b);var c=a("<div>",{"class":"parameters"}),d={},e={names:[]};b.parameters.forEach(function(a){d[a.name]=a,e.names.push(a.name),e[a.name+"_operators"]=a.operators&&a.operators,e[a.name+"_values"]=a.values&&a.values});var f=function(){a("<ul></ul>");return{lis:function(){},input:function(){},hide:function(){},show:function(){}}}(),g=function(e,g,h){var i=this;this.$=a("<div>",{"class":"parameter"}).append(a("<span></span>",{id:"remove",html:"&times;"}).on("click",function(){i.$.remove()}),this.name=a("<input>",{type:"text",spellcheck:"false",autocomplete:"off",id:"name",value:e,style:"width:1px;",list:"names"}),this.operator=a("<input>",{type:"text",spellcheck:"false",autocomplete:"off",id:"operator",value:g,style:"width:1px;"}),this.value=a("<input>",{type:"text",spellcheck:"false",autocomplete:"off",id:"value",value:h,style:"width:10px;"})).on("keydown","input",function(b){var c=a(b.target);13===b.keyCode&&c.next().focus()}).on("blur","input",function(){}).on("input","input",function(){var d={number:17,date:57},e=a(this),g=e.val(),h=0!==g.length?g:e.attr("placeholder")||"";console.log(g,g.length,e.attr("type"));var i=a("<span>",{"class":b["class"]}).css(jQuery.extend({position:"absolute",width:"auto",visibility:"hidden",whiteSpace:"pre"},e.css(["font-size","font-family","font-weight","font-style","font-variant","word-spacing","letter-spacing","text-indent","text-rendering","text-transform"]))).text(h).appendTo(c),j=i.width();i.remove(),e.width(j+(d[e.attr("type")]||0)+1+(void 0!==e.attr("list")?20:0)),f.input()}),this.name.on("focus",function(){console.log("Open autoComplete")}).on("blur",function(){var a=i.name.val(),c=d[a]||{};return i.operator.attr(jQuery.extend({placeholder:""},c.operatorAttrs||{},{type:"text",list:a})).trigger("input"),i.value.attr(jQuery.extend({type:"text",placeholder:""},c.valueAttrs||{},{type:c.type||c.valueAttrs&&c.valueAttrs.type||"text",list:a+"_values"})).trigger("input"),b.strict&&!d.hasOwnProperty(a)?"Error":void 0}),this.value.on("blur",function(){i.value[0].checkValidity()?i.$.removeClass("error"):i.$.addClass("error")})};b.defaultQuery.forEach(function(a){(!b.strict||a.name in d)&&(a=new g(a.name,a.operator,a.value,a.type),a.$.appendTo(c))}),c.on("focusin",function(){c.addClass("selected")}).on("blur","input",function(){c.removeClass("selected")}).on("mousedown",function(b){if(a(b.target).is(c)){b.preventDefault(),a("div.parameter.selected",c).removeClass("selected");var d;a("div.parameter",c).each(function(){var c=a(this),e=c.offset();return e.top>b.pageY||e.top<b.pageY&&b.pageY<e.top+c.height()&&e.left>b.pageX?!1:void(d=c)});var e=new g;e.$[void 0!==d?"insertAfter":"prependTo"](d||this),e.name.focus()}}),this.html(c)}}(window.jQuery);